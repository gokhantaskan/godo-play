## ADDED Requirements

### Requirement: Expression index for JSONB popularity sort

The `game` table SHALL have a functional B-tree index on `((external->>'igdbAggregatedRating')::float)` with `DESC NULLS LAST` ordering to support popularity sorting without full table scans.

The index SHALL be defined in the Drizzle schema (`server/db/schema/tables/games.ts`) using the `index()` API with a `.using()` SQL expression, and named `game_external_igdb_rating_idx`.

#### Scenario: Public game listing sorted by popularity

- **WHEN** a request is made to the public games endpoint with `sort=-popularity` (the default)
- **THEN** PostgreSQL SHALL use the expression index for ordered retrieval instead of performing a sequential scan and in-memory sort

#### Scenario: Index definition in Drizzle schema

- **WHEN** the schema is inspected
- **THEN** the `games` table extraConfig SHALL contain an index entry using `sql` template for `((external->>'igdbAggregatedRating')::float DESC NULLS LAST)`

### Requirement: Composite index for status + created_at queries

The `game` table SHALL have a composite B-tree index named `game_status_created_at_idx` on `(status, created_at DESC)` to support queries that filter by status and sort by creation date.

#### Scenario: Admin listing filtered by status and sorted by date

- **WHEN** a request filters games by `status=pending` and sorts by `-created_at`
- **THEN** PostgreSQL SHALL satisfy both the filter and sort from a single index scan

#### Scenario: Index covers multiple status values

- **WHEN** a request filters by `status IN ('pending', 'approved')` and sorts by `created_at DESC`
- **THEN** the composite index SHALL be usable for the combined filter and sort operation

### Requirement: Partial index for approved games

The `game` table SHALL have a partial B-tree index named `game_approved_created_at_idx` on `(created_at DESC)` with the condition `WHERE status = 'approved'`.

This index SHALL only include rows where `status = 'approved'`, reducing index size and improving write performance for non-approved rows.

#### Scenario: Public listing of approved games

- **WHEN** the public games endpoint queries with an implicit `status = 'approved'` filter
- **THEN** PostgreSQL SHALL use the partial index which contains only approved game rows, providing faster lookups than the full composite index

#### Scenario: Non-approved game insert does not update partial index

- **WHEN** a new game is inserted with `status = 'pending'`
- **THEN** the partial index SHALL NOT be updated, avoiding unnecessary write overhead

### Requirement: Migration generation for new indexes

All new indexes SHALL be created via Drizzle schema definitions and captured in a migration file generated by `pnpm db:generate`. No manual SQL migration files SHALL be required.

#### Scenario: Generate migration after schema changes

- **WHEN** `pnpm db:generate` is run after adding the new index definitions
- **THEN** a new migration file SHALL be created in `server/db/migrations/` containing `CREATE INDEX` statements for all new indexes

#### Scenario: Migration is idempotent

- **WHEN** `pnpm db:migrate` is run on a database that already has the indexes
- **THEN** the migration system SHALL skip already-applied migrations without error
